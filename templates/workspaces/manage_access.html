{% extends "base.html" %}
{% block title %}Manage Workspace Access â€“ {{ org.name }}{% endblock %}
{% load dict_extras %}

{% block content %}
<style>
    /* --- MANAGE ACCESS STYLES --- */
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 1rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 800;
        color: #fff;
        margin: 0;
    }

    /* Access Card */
    .access-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-card);
        padding: 30px;
        position: relative;
    }

    /* Custom Accordion */
    .accordion-item {
        background: transparent;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .accordion-header button {
        background: rgba(255,255,255,0.02);
        color: #fff;
        font-weight: 700;
        box-shadow: none;
        padding: 16px 20px;
    }
    .accordion-header button:not(.collapsed) {
        background: rgba(167, 105, 237, 0.1);
        color: var(--color-primary);
        box-shadow: none; /* Remove default blue shadow */
    }
    .accordion-header button::after {
        filter: invert(1); /* Make arrow white */
    }
    .accordion-header button:not(.collapsed)::after {
        filter: invert(0.5) sepia(1) saturate(5) hue-rotate(230deg); /* Make arrow purpleish */
    }
    .accordion-body {
        background: #080808;
        border-top: 1px solid var(--color-border);
        padding: 20px;
    }

    /* Dark Table */
    .table-dark-custom {
        width: 100%;
        color: var(--color-text);
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0 4px;
    }
    .table-dark-custom th {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--color-muted);
        border-bottom: 1px solid var(--color-border);
        padding: 8px 12px;
        font-weight: 700;
    }
    .table-dark-custom td {
        background: rgba(255,255,255,0.02);
        padding: 12px;
        vertical-align: middle;
        border-top: 1px solid var(--color-border);
        border-bottom: 1px solid var(--color-border);
    }
    .table-dark-custom tr td:first-child { border-left: 1px solid var(--color-border); border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
    .table-dark-custom tr td:last-child { border-right: 1px solid var(--color-border); border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

    /* Inputs */
    .form-check-input {
        background-color: #222;
        border-color: #555;
        width: 1.2em; height: 1.2em;
        cursor: pointer;
    }
    .form-check-input:checked {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
        box-shadow: 0 0 10px rgba(167, 105, 237, 0.4);
    }

    .form-select-dark {
        background: #050505;
        border: 1px solid var(--color-border);
        color: #fff;
        border-radius: 8px;
        padding: 6px 30px 6px 10px; /* Space for arrow */
        font-size: 0.9rem;
    }
    .form-select-dark:disabled {
        opacity: 0.5;
        background: #111;
        cursor: not-allowed;
    }

    /* Badges */
    .role-pill {
        display: inline-block;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.2);
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

</style>

<div class="row justify-content-center">
  <div class="col-lg-11" style="max-width: 1200px;">
    
    <!-- Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Manage Access</h1>
        <p class="text mb-0">Control user permissions across workspaces.</p>
      </div>
      <a href="{% url 'dashboard' %}" class="btn btn-custom btn-ghost">
        <i class="fa-solid fa-arrow-left me-2"></i> Dashboard
      </a>
    </div>

    <form method="post">
      {% csrf_token %}

      <div class="access-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="h5 text-white mb-1"><i class="fa-solid fa-shield-halved text-primary me-2"></i> Workspace Permissions</h2>
            <p class="small text mb-0">Select users to grant access. Assign roles (Admin/Operator) per workspace.</p>
          </div>
          <div class="small text-warning bg-opacity-10 bg-warning px-3 py-1 rounded border border-warning border-opacity-25">
            <i class="fa-solid fa-lightbulb me-1"></i> Check box to enable role selection
          </div>
        </div>

        {% if workspaces %}
          <div class="accordion" id="wsAccordion">
            {% for ws in workspaces %}
              {% with ws_roles=access_map|get_item:ws.id %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingWs{{ ws.id }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWs{{ ws.id }}" aria-expanded="false">
                    <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fa-solid fa-laptop-file"></i>
                            <span>{{ ws.name }}</span>
                            <span class="text small" style="font-family:monospace; opacity:0.6;">{{ ws.workspace_code }}</span>
                        </div>
                        <span class="badge bg-dark border border-secondary text-white">
                            {{ ws_roles|length|default:0 }} Members
                        </span>
                    </div>
                  </button>
                </h2>
                
                <div id="collapseWs{{ ws.id }}" class="accordion-collapse collapse" data-bs-parent="#wsAccordion">
                  <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table-dark-custom">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th class="text-center">Access</th>
                                    <th>Workspace Role</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in users %}
                                  {% with mem_role=ws_roles|get_item:u.id %}
                                  <tr>
                                      <td>
                                          <div class="fw-bold text-white">{{ u.get_full_name|default:"User" }}</div>
                                          <div class="role-pill mt-1">{{ u.get_role_display|default:u.role }}</div>
                                      </td>
                                      <td class="text small">{{ u.email }}</td>
                                      <td class="text-center">
                                          <div class="form-check d-flex justify-content-center">
                                              <input type="checkbox" 
                                                     class="form-check-input ws-access-toggle"
                                                     name="ws_{{ ws.id }}_user_{{ u.id }}"
                                                     id="ws_{{ ws.id }}_user_{{ u.id }}"
                                                     data-role-select="ws_{{ ws.id }}_role_{{ u.id }}"
                                                     {% if mem_role %}checked{% endif %}>
                                          </div>
                                      </td>
                                      <td>
                                          <select name="ws_{{ ws.id }}_role_{{ u.id }}"
                                                  id="ws_{{ ws.id }}_role_{{ u.id }}"
                                                  class="form-select form-select-dark form-select-sm"
                                                  {% if not mem_role %}disabled{% endif %}>
                                              {% for value, label in membership_role_choices %}
                                                  <option value="{{ value }}" {% if mem_role == value %}selected{% endif %}>
                                                      {{ label }}
                                                  </option>
                                              {% endfor %}
                                          </select>
                                      </td>
                                  </tr>
                                  {% endwith %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                  </div>
                </div>
              </div>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-5 text border border-dashed border-secondary rounded">
              <i class="fa-regular fa-folder-open mb-3" style="font-size:2rem;"></i>
              <p>No workspaces found. Create one to manage access.</p>
          </div>
        {% endif %}

        <div class="d-flex justify-content-end mt-4 pt-3 border-top border-secondary">
            <button type="submit" class="btn btn-custom btn-primary-glow px-5">
                <i class="fa-solid fa-save me-2"></i> Save Changes
            </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("change", (e) => {
        const cb = e.target.closest(".ws-access-toggle");
        if (!cb) return;

        const selId = cb.getAttribute("data-role-select");
        const sel = document.getElementById(selId);
        if (!sel) return;

        sel.disabled = !cb.checked;
        if (cb.checked && !sel.value) sel.selectedIndex = 0;
    });
</script>
{% endblock %}